---
title: 主成分分析PCA
author: 张剑
date: '2020-03-25'
slug: 主成分分析pca
categories:
  - 项目评估
tags:
  - R
output:
  blogdown::html_page:
    toc: true
---

### What —— 主成分分析的基本思想
利用降维（线性变换)的思想，在损失很少信息的前提下把多个特征转化为几个不相关的综合特征（主成分),即每个主成分都是原始特征变量的线性组合,且各个主成分之间互不相关,使得主成分比原始变量具有某些更优越的性能（主成分必须保留原始特征尽可能多的信息），从而达到简化系统结构，抓住问题实质的目的。

### Why —— 为什么我们需要主成分分析
假设我们的研究对象——消费者，我们拥有消费者非常全面的特征，如果要将这p个特征$x_1,x_2,...,x_p$个特征可视化，实际上是相对繁琐的，人们对于太多维度的变量处理起来不够符合人类的直觉思维。

### 一个多维特征的例子
```{r message=FALSE, warning=FALSE}
library(corrplot)
library(DT)
library(tidyverse)
library(GGally)
library(gtsummary)
mtcars[1:7] %>% datatable()

ggpairs(mtcars[1:7]) +  theme_bw() 


res1 <- cor.mtest(mtcars[1:7], conf.level = .95)
corrplot(corr=cor(mtcars[1:7]),order = "AOE",type="upper",method='pie',tl.pos = "d", p.mat = res1$p, sig.level = .1)
corrplot(corr = cor(mtcars[1:7]),add=TRUE, type="lower", method="number",order="AOE",diag=FALSE,tl.pos="n", cl.pos="n",col="black")

```

实际上这么多变量对人类进行直观分析是不友好的，虽然图画的比较漂亮，但是很可能没有图是有价值的，因为每个图或者每个特征只包含了极少的信息。很显然，如果我们研究对象的特征变得更多的时候，**需要寻求一个更好的方法来可视化特征**。

#### 需要一种对数据的低纬表示，而这些表示可以尽可能多的包含特征的信息。比如，得到一个二维表示来获取数据中的大部分信息，那么就可以在这个低维空间中绘制出观测图像。

![](/post/2020-03-25-主成分分析pca_files/1.png)

#### 绿色实线代表数据的第一主成分方向，在这个方向上数据的波动性最大，垂直于这条线的方向的蓝色线。

$$Z_{1}=0.839 \times(\mathrm{pop}-\overline{\mathrm{pop}})+0.544 \times(\mathrm{ad}-\overline{\mathrm{ad}})$$
$\phi_{11}=0.839, \phi_{21}=0.544$是主成分载荷，定义了主成分的方向。在满足$\phi_{11}^2+\phi_{21}^2=1$的约束下所有可能的pop和ad的组合里，是的这个组合的方差最大。方差大解释的变异也就越，本质上这里的目标是
$$MAX:\operatorname{Var}\left(\phi_{11} \times(\operatorname{pop}-\overline{\mathrm{pop}})+\phi_{21} \times(\mathrm{ad}-\overline{\mathrm{ad}})\right)$$
当观测值100个的时候，pop和ad也有对应的100，那么每个观测值都有一个对应的主成分：
$$Z_{i1}=0.839 \times(\mathrm{pop_i}-\overline{\mathrm{pop_i}})+0.544 \times(\mathrm{ad_i}-\overline{\mathrm{ad_i}})$$
### 这些对应的$z_{i1},z_{i2}$被称为主成得分(principal component scores),下图表征了主成分得分的图例.

![](/post/2020-03-25-主成分分析pca_files/2.png)

### 主成分的另一种解释
第一主成分向量定义了与数据最接近的那条线，第一主成分线使得所有点到该线的垂直距离平方和最小。第一主成分的选择使得投影得到的观测与原始观测最为接近。

***

#### 主成分$z_i$可以看作为在每个对应位置上对pop和ad数值的汇总。如果某个观测值的$zi$是小于0的，表示这个观测值的两个维度ad和pop特征是低于平均水平的。那么我就做到了使用一个特征变量来指代两个特征变量的目标。

当然如果需要分析的对象有多个维度，我们还可以构造更多的主成分，目标就是使得这些主成分的方差最大，并满足不相关(垂直)条件。

### How——如何进行PCA？
1. Scale Your Feature
2. Missing Value: 删除
3. Categorical Data

### 先做一个Scale和不Scale的对比
```{r message=FALSE, warning=FALSE}
library(ggplot2)
data("USArrests")
USArrests %>% tbl_summary(statistic = list(all_continuous() ~ "均值：{mean} 方差：{sd}，最大值:{max},最小值:{min}"))

pr.withoutsc <- prcomp(USArrests,scale =F )
pr.withsc <- prcomp(USArrests,scale =T,)

biplot(pr.withoutsc)
biplot(pr.withsc)

names(pr.withsc)
pr.withsc$center
pr.withsc$scale
#rotation矩阵提供了主成分的载荷信息
pr.withsc$rotation

```

#### 如果希望观察每个观测值或者说周的某个主成分得分比如PC1第一个主成分得分

```{r message=FALSE, warning=FALSE}
head(pr.withsc$x)
as.data.frame(pr.withsc$x) %>% select(PC1,PC2) %>% datatable()
```

### 碎石图，选几个主成分
#### 接下来画一个碎石图，观察主成分个数增加对特征向量解释力度的变化

```{r}
pr.var <- (pr.withsc$sdev)^2
pve <- pr.var / sum(pr.var)
df <- tibble(x=seq(1,4,by=1),y=pve)
ggplot(df,aes(x=x,y=y))+
  geom_point()+geom_line() +theme_bw() +ggtitle("碎石图")+
  xlab('主成分个数') + ylab('每个主成分解释的变异')
```

#### 通常可以通过看碎石图来决定所需的主成分数量。我们选择满足要求的最少数量的主成分来解释数据中的绝大部分变异。

#### 通过观察碎石图，可以找到一个点，在这个点上，主成分解释的方差比例突然减少。

#### 这个点就被视为肘(elbow),选择肘出现的个数作为主成分分析的个数。

> 这种可视化分析感觉有些随意。遗憾的是，没有一个被广泛认可的客观方法来决定多少主成分才够用。事实上，多少个主成分才够用这个提法就比较欠妥，这个问题取决于特定的应用领域和特定的数据集。

***

> 在实践中，往往通过看前几个主成分来寻找数据中有价值的模式。如果在前几个主成分中都找不到有价值的模式，那更多的主成分也不太可能会有价值。相反，如果前几个主成分有价值，那通常会继续观察随后的主成分，直到找不到更多有价值的模式为止。